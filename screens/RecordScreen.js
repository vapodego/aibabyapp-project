import React, { useEffect, useState } from 'react';
import {
    View,
    Text,
    StyleSheet,
    TextInput,
    Button,
    FlatList,
    Alert,
    Platform,
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { Picker } from '@react-native-picker/picker';
import DateTimePicker from '@react-native-community/datetimepicker';
import { v4 as uuidv4 } from 'uuid';
import { InteractionManager } from 'react-native';

export default function RecordScreen({ navigation }) {
    const [recordType, setRecordType] = useState('„Éü„É´„ÇØ');
    const [amount, setAmount] = useState('');
    const [note, setNote] = useState('');
    const [style, setStyle] = useState('');
    const [menu, setMenu] = useState('');
    const [temp, setTemp] = useState('');
    const [startTime, setStartTime] = useState(new Date());
    const [endTime, setEndTime] = useState(new Date());
    const [showStartPicker, setShowStartPicker] = useState(false);
    const [showEndPicker, setShowEndPicker] = useState(false);
    const [bathTime, setBathTime] = useState(new Date());
    const [showBathPicker, setShowBathPicker] = useState(false);
    const [records, setRecords] = useState([]);
    const [appReady, setAppReady] = useState(false);

    const saveRecord = async () => {
        console.log('üêõ saveRecord „ÅåÂëº„Å∞„Çå„Åæ„Åó„Åü');
        console.log('üìã recordType:', recordType);
        console.log('üì• ÂÖ•ÂäõÂÄ§:', { amount, note, style, temp, menu });

        let data = {};

        switch (recordType) {
            case '„Éü„É´„ÇØ':
                if (!amount.trim()) {
                    Alert.alert('„Ç®„É©„Éº', 'ÈáèÔºàmlÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                data = { amount, note };
                break;
            case 'ÊéíÊ≥Ñ':
                if (!style.trim()) {
                    Alert.alert('„Ç®„É©„Éº', 'ÊéíÊ≥Ñ„Çπ„Çø„Ç§„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                data = { style, note };
                break;
            case 'Áù°Áú†':
                data = { start: startTime.toLocaleString(), end: endTime.toLocaleString(), note };
                break;
            case 'Èõ¢‰π≥È£ü':
                if (!menu.trim() || !amount.trim()) {
                    Alert.alert('„Ç®„É©„Éº', 'È£ü„Åπ„Åü„ÇÇ„ÅÆ„Å®Èáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                data = { menu, amount, note };
                break;
            case '‰ΩìÊ∏©':
                if (!temp.trim()) {
                    Alert.alert('„Ç®„É©„Éº', '‰ΩìÊ∏©„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                data = { temp, note };
                break;
            case 'ÂÖ•Êµ¥':
                data = { time: bathTime.toLocaleString(), note };
                break;
            default:
                Alert.alert('‰∏çÊòé„Å™Ë®òÈå≤„Çø„Ç§„Éó');
                return;
        }

        const newRecord = {
            id: uuidv4(),
            type: recordType,
            time: new Date().toLocaleString(),
            data,
        };

        const updated = [newRecord, ...records];
        console.log('üß™ ‰øùÂ≠òÂØæË±°„Éá„Éº„Çø(JSON):', JSON.stringify(updated));
        setRecords(updated);

        try {
            await AsyncStorage.setItem('records', JSON.stringify(updated));
            console.log('‚úÖ setItem ÊàêÂäü');
            // ‰øùÂ≠òÁõ¥Âæå„Å´ÂÜçÂèñÂæó„Åó„Å¶Á¢∫Ë™çÔºàAndroidÊ§úË®ºÁî®Ôºâ
            setTimeout(async () => {
                const reloaded = await AsyncStorage.getItem('records');
                console.log('üß™ setTimeout„ÅßÂÜçÂèñÂæó:', reloaded);
            }, 1000); // 1ÁßíÈÅÖÂª∂„ÅßÁ¢∫Ë™ç

            const verify = await AsyncStorage.getItem('records');
            console.log('üß™ ‰øùÂ≠òÁõ¥Âæå„ÅÆÂÜçÂèñÂæó:', verify);

            await loadRecords();
            Alert.alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü', `${recordType}„ÅÆË®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ`);
            try {
                await AsyncStorage.setItem('testKey', JSON.stringify({ hello: 'android' }));
                const verify = await AsyncStorage.getItem('testKey');
                console.log('üß™ testKeyÁ¢∫Ë™çÔºàAndroidÔºâ:', verify);
            } catch (e) {
                console.error('‚ùå testKey‰øùÂ≠òÂ§±Êïó:', e);
            }

            // „Åì„ÅÆÂæå„ÄÅÂÖ•ÂäõÂÄ§ÂàùÊúüÂåñ„Åó„Å¶OK
            setAmount('');
            setNote('');
            setStyle('');
            setMenu('');
            setTemp('');
        } catch (err) {
            console.error('‚ùå AsyncStorage ‰øùÂ≠òÂ§±Êïó:', err);
            Alert.alert('‰øùÂ≠òÂ§±Êïó', '„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }

        setAmount(''); setNote(''); setStyle(''); setMenu(''); setTemp('');
    };
    const testAsyncStorage = async () => {
        const dummy = [{ id: '1', type: '„Éü„É´„ÇØ', time: new Date().toLocaleString(), data: { amount: 100, note: 'test' } }];
        try {
            await AsyncStorage.setItem('records', JSON.stringify(dummy));
            const result = await AsyncStorage.getItem('records');
            console.log('üß™ ÊâãÂãï‰øùÂ≠òÁ¢∫Ë™ç:', result);
        } catch (e) {
            console.error('‚ùå ÊâãÂãï‰øùÂ≠òÂ§±Êïó:', e);
        }
    };
    const loadRecords = async () => {
        try {
            const data = await AsyncStorage.getItem('records');
            console.log("üß™ AsyncStorage„Åã„ÇâÂèñÂæó„Åó„Åüdata:", data);
            const parsed = JSON.parse(data) || [];
            const cleaned = parsed.filter(item => item && typeof item === 'object');
            const normalized = cleaned.map(item => {
                if (!item.data) {
                    const { id, type, time, amount, note, style, menu, temp, start, end, ...rest } = item;
                    return {
                        id,
                        type,
                        time,
                        data: { amount, note, style, menu, temp, start, end, ...rest },
                    };
                }
                return item;
            });
            console.log("üß™ Ê≠£Ë¶èÂåñ„Åï„Çå„Åürecords:", normalized);
            setRecords(normalized);
        } catch (err) {
            console.error('‚ùå AsyncStorage ‰øùÂ≠òÂ§±Êïó:', err);
            Alert.alert('‰øùÂ≠òÂ§±Êïó', '„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
    };

    const renderInputFields = () => {
        switch (recordType) {
            case '„Éü„É´„ÇØ':
                return (<>
                    <TextInput placeholder="ÈáèÔºàmlÔºâ" value={amount} onChangeText={setAmount} keyboardType="numeric" style={styles.input} />
                    <TextInput placeholder="„É°„É¢" value={note} onChangeText={setNote} style={styles.input} />
                </>);
            case 'ÊéíÊ≥Ñ':
                return (<>
                    <TextInput placeholder="„Çπ„Çø„Ç§„É´Ôºà„ÅÜ„Çì„Å°Ôºè„Åä„Åó„Å£„ÅìÔºâ" value={style} onChangeText={setStyle} style={styles.input} />
                    <TextInput placeholder="„É°„É¢" value={note} onChangeText={setNote} style={styles.input} />
                </>);
            case 'Áù°Áú†':
                return (<>
                    <Button title={`ÈñãÂßã: ${startTime.toLocaleTimeString()}`} onPress={() => setShowStartPicker(true)} />
                    {showStartPicker && <DateTimePicker value={startTime} mode="time" is24Hour display="default" onChange={(e, date) => { setShowStartPicker(Platform.OS === 'ios'); if (date) setStartTime(date); }} />}
                    <Button title={`ÁµÇ‰∫Ü: ${endTime.toLocaleTimeString()}`} onPress={() => setShowEndPicker(true)} />
                    {showEndPicker && <DateTimePicker value={endTime} mode="time" is24Hour display="default" onChange={(e, date) => { setShowEndPicker(Platform.OS === 'ios'); if (date) setEndTime(date); }} />}
                    <TextInput placeholder="„É°„É¢" value={note} onChangeText={setNote} style={styles.input} />
                </>);
            case 'Èõ¢‰π≥È£ü':
                return (<>
                    <TextInput placeholder="È£ü„Åπ„Åü„ÇÇ„ÅÆ" value={menu} onChangeText={setMenu} style={styles.input} />
                    <TextInput placeholder="ÈáèÔºàgÔºâ" value={amount} onChangeText={setAmount} keyboardType="numeric" style={styles.input} />
                    <TextInput placeholder="„É°„É¢" value={note} onChangeText={setNote} style={styles.input} />
                </>);
            case '‰ΩìÊ∏©':
                return (<>
                    <TextInput placeholder="‰ΩìÊ∏©Ôºà‚ÑÉÔºâ" value={temp} onChangeText={setTemp} keyboardType="numeric" style={styles.input} />
                    <TextInput placeholder="„É°„É¢" value={note} onChangeText={setNote} style={styles.input} />
                </>);
            case 'ÂÖ•Êµ¥':
                return (<>
                    <Button title={`ÂÖ•Êµ¥ÊôÇÂàª: ${bathTime.toLocaleTimeString()}`} onPress={() => setShowBathPicker(true)} />
                    {showBathPicker && <DateTimePicker value={bathTime} mode="time" is24Hour display="default" onChange={(e, date) => { setShowBathPicker(Platform.OS === 'ios'); if (date) setBathTime(date); }} />}
                    <TextInput placeholder="„É°„É¢" value={note} onChangeText={setNote} style={styles.input} />
                </>);
            default:
                return null;
        }
    };

    useEffect(() => {
        loadRecords();
    }, []);
    useEffect(() => {
        const testSave = async () => {
            try {
                await AsyncStorage.setItem('testSave', JSON.stringify({ hello: 'android!' }));
                const result = await AsyncStorage.getItem('testSave');
                console.log('üß™ testSave ‰øùÂ≠ò ‚Üí ÂèñÂæó:', result);
            } catch (e) {
                console.error('‚ùå testSave ‰øùÂ≠òÂ§±Êïó:', e);
            }
        };
        testSave();
    }, []);
    useEffect(() => {
        InteractionManager.runAfterInteractions(() => {
            setAppReady(true);
        });
    }, []);

    if (!appReady) {
        return (
            <View style={styles.container}>
                <Text>‚è≥ Ê∫ñÂÇô‰∏≠...</Text>
            </View>
        );
    }

    return (
        <View style={styles.container}>
            <Text style={styles.header}>üìã Ë®òÈå≤ÂÖ•Âäõ</Text>
            <Picker selectedValue={recordType} onValueChange={setRecordType}>
                <Picker.Item label="üçº „Éü„É´„ÇØ" value="„Éü„É´„ÇØ" />
                <Picker.Item label="üöΩ ÊéíÊ≥Ñ" value="ÊéíÊ≥Ñ" />
                <Picker.Item label="üí§ Áù°Áú†" value="Áù°Áú†" />
                <Picker.Item label="üçö Èõ¢‰π≥È£ü" value="Èõ¢‰π≥È£ü" />
                <Picker.Item label="üå° ‰ΩìÊ∏©" value="‰ΩìÊ∏©" />
                <Picker.Item label="üõÅ ÂÖ•Êµ¥" value="ÂÖ•Êµ¥" />
            </Picker>
            {renderInputFields()}
            <Button title="Ë®òÈå≤„Åô„Çã" onPress={saveRecord} />
            <View style={[styles.list, { flex: 1 }]}>
                <Text style={styles.subHeader}>üóÇ Ë®òÈå≤‰∏ÄË¶ß</Text>
                {records.length === 0 ? (
                    <Text style={styles.empty}>üìå Ë®òÈå≤„Åå„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</Text>
                ) : (
                    <FlatList
                        style={{ flexGrow: 1 }}
                        data={records}
                        keyExtractor={(item, index) => item?.id || index.toString()}
                        renderItem={({ item }) => {
                            const recordData = item.data || {};
                            return (
                                <View style={styles.item}>
                                    <Text>
                                        üïí {item.time} - üè∑ {item.type}{' '}
                                        {recordData.amount && `üì¶ ${recordData.amount}`}
                                        {recordData.style && `üöΩ ${recordData.style}`}
                                        {recordData.menu && `üçΩ ${recordData.menu}`}
                                        {recordData.temp && `üå° ${recordData.temp}`}
                                        {recordData.start && recordData.end && `üí§ ${recordData.start}„Äú${recordData.end}`}
                                        {recordData.time && `üõÅ ${recordData.time}`}
                                    </Text>
                                    {recordData.note ? <Text style={styles.note}>üìù {recordData.note}</Text> : null}
                                </View>
                            );
                        }}
                    />
                )}
            </View>
            <View style={styles.chatButton}>
                <Button title="„Åæ„Å™ÂÖàÁîü„Å®„ÅäË©±„Åó„Åô„Çã" onPress={() => navigation.navigate('Chat')} color="#007AFF" />
            </View>
        </View>
    );
}

const styles = StyleSheet.create({
    container: { flex: 1, padding: 16, backgroundColor: '#fff8f0' },
    header: { fontSize: 20, marginBottom: 12 },
    subHeader: { fontSize: 16, marginTop: 20, marginBottom: 8 },
    input: {
        backgroundColor: '#fff',
        padding: 10,
        borderWidth: 1,
        borderColor: '#ccc',
        marginBottom: 8,
        borderRadius: 6,
    },
    list: { marginTop: 16 },
    item: {
        padding: 10,
        borderBottomWidth: 1,
        borderColor: '#ddd',
    },
    note: { color: '#555', fontSize: 12 },
    empty: { color: '#777', fontSize: 14, marginTop: 10 },
    chatButton: { marginTop: 16 },
});
